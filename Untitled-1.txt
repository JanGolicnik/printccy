#include <stdio.h>
#include <stdarg.h> 

void my_print_int(va_list* args) {
    int val = va_arg(*args, int);
    printf("int %d\n", val);
}

void my_print_float(va_list* args) {
    float val = va_arg(*args, double);
    printf("float %f\n", val);
}

void my_print_double(va_list* args) {
    double val = va_arg(*args, double);
    printf("double %f\n", val);
}

typedef void(_my_print_func)(va_list* args);
_Thread_local _my_print_func* _my_print_funcs[128];
_Thread_local _my_print_func** _my_funcs_ptr = NULL;

void _my_print(int n, ...)
{
    va_list args; va_start(args, n);
    _my_funcs_ptr = _my_print_funcs;
    for(int i = 0; i < n; i++) 
        (*_my_funcs_ptr++)(&args);
    va_end(args);
}


// https://groups.google.com/g/comp.std.c/c/d-6Mj5Lko_s?pli=1
#define __NARG__(...)  __NARG_I_( __VA_ARGS__, __RSEQ_N() )
#define __NARG_I_(...) __ARG_N( __VA_ARGS__ )
#define __ARG_N( _1, _2, _3, _4, _5, _6, _7, N, ... ) N
#define __RSEQ_N() 7, 6, 5, 4, 3, 2, 1, 0

#define _MY_MATCH_ARG_TYPE_BASE int: &my_print_int, float: &my_print_float, double: &my_print_double

#ifndef _MY_MATCH_ARG_TYPE_CUSTOM
// should be defined with a comma in front: #define _MY_MATCH_ARG_TYPE_CUSTOM , my_type: ...
#define _MY_MATCH_ARG_TYPE_CUSTOM
#endif // _MY_MATCH_ARG_TYPE_CUSTOM

#ifndef _MY_MATCH_ARG_TYPE
#define _MY_MATCH_ARG_TYPE(X) _Generic((X), _MY_MATCH_ARG_TYPE_BASE _MY_MATCH_ARG_TYPE_CUSTOM, default: 0)
#endif // _MY_MATCH_ARG_TYPE

#define _MY_ASSERT(expr, msg) sizeof(struct { _Static_assert(expr, msg); int _dummy; })
#define _MY_ASSERT_NON_ZERO_OR_EVAL(expr, msg) (_MY_ASSERT(expr != 0, msg), expr)

#define _MY_FILL_FPTR(X) *(_my_funcs_ptr++) = _MY_ASSERT_NON_ZERO_OR_EVAL(_MY_MATCH_ARG_TYPE(X), "unsupported type of variable " #X)

#define _MY_FILL_FPTR1(_0) _MY_FILL_FPTR(_0)
#define _MY_FILL_FPTR2(_0, _1) _MY_FILL_FPTR(_0); _MY_FILL_FPTR(_1)
#define _MY_FILL_FPTR3(_0, _1, _2) _MY_FILL_FPTR(_0); _MY_FILL_FPTR(_1); _MY_FILL_FPTR(_2)
#define _MY_FILL_FPTR4(_0, _1, _2, _3) _MY_FILL_FPTR(_0); _MY_FILL_FPTR(_1); _MY_FILL_FPTR(_2); _MY_FILL_FPTR(_3)
#define _MY_FILL_FPTR5(_0, _1, _2, _3, _4) _MY_FILL_FPTR(_0); _MY_FILL_FPTR(_1); _MY_FILL_FPTR(_2); _MY_FILL_FPTR(_3); _MY_FILL_FPTR(_4)
#define _MY_FILL_FPTR6(_0, _1, _2, _3, _4, _5) _MY_FILL_FPTR(_0); _MY_FILL_FPTR(_1); _MY_FILL_FPTR(_2); _MY_FILL_FPTR(_3); _MY_FILL_FPTR(_4); _MY_FILL_FPTR(_5)
#define _MY_FILL_FPTR7(_0, _1, _2, _3, _4, _5, _6) _MY_FILL_FPTR(_0); _MY_FILL_FPTR(_1); _MY_FILL_FPTR(_2); _MY_FILL_FPTR(_3); _MY_FILL_FPTR(_4); _MY_FILL_FPTR(_5); _MY_FILL_FPTR(_6)

#define _MY_OVERLOAD_MACRO(_0, _1, _2, _3, _4, _5, _6, MACRO_NAME, ...) MACRO_NAME

#define PRINT(...) do { _my_funcs_ptr = _my_print_funcs;\
                        _MY_OVERLOAD_MACRO( __VA_ARGS__, _MY_FILL_FPTR7, _MY_FILL_FPTR6, _MY_FILL_FPTR5, _MY_FILL_FPTR4, _MY_FILL_FPTR3, _MY_FILL_FPTR2, _MY_FILL_FPTR1 )( __VA_ARGS__ );\
                        _my_print( __NARG__( __VA_ARGS__ ), __VA_ARGS__ );\
                      } while(0)

int main()
{
    PRINT(1, 2.0f, 3.0, "hey");
}